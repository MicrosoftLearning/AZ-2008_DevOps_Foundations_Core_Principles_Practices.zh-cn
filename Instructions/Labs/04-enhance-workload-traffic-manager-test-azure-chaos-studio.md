---
lab:
  title: 使用流量管理器增强工作负荷的复原能力，并使用 Azure Chaos Studio 测试复原能力
  module: Operate with DevOps
---

# 实验室 04 - 使用流量管理器增强工作负荷的复原能力，并使用 Azure Chaos Studio 测试复原能力

## 预计用时：35 分钟

## 场景

请记住此模块的场景，其中你为一家零售行业的软件开发公司工作，该公司的新在线商店应用程序经常遇到故障和性能问题。 由于你已决定分别使用流量管理器和 Azure Chaos Studio 增强工作负载和测试复原能力，因此本实验室为你提供了实现流量管理器配置文件并验证流量管理器功能、配置 Azure Chaos Studio 环境以及实现和验证试验的机会。

## 目标

在此实验中，将执行以下操作：

- 为实验室准备 Azure 订阅
- 使用流量管理器增强工作负载复原能力
- 使用 Azure Chaos Studio 测试工作负载复原能力
- 删除实验室中使用的资源

> **注意：** 在之前的实验室中，你已将两个 .NET web 应用实例部署到 Azure 区域。 在本实验室中，你将首先创建一个可复原的配置，用于在两个 Web 应用实例之间实现 Azure 流量管理器的负载均衡功能。 接下来，你将使用 Azure Chaos Studio 触发其中一个应用的故障，以测试负载均衡实现的复原能力。

> **注意：** 对于此实验室，请使用在以前所有实验室中使用的同一 GitHub 帐户。

## 先决条件

- 已完成的 [实验室 01 - 使用 GitHub 进行敏捷规划和管理](01-agile-planning-management-using-github.md)
- 已完成的 [实验室 02 - 使用 GitHub 实现工作流](02-implement-manage-repositories-using-github.md)
- 已完成的 [实验室 03 - 使用 GitHub Actions 实现 CI/CD 和使用 Bicep 实现 IaC](03-implement-ci-cd-with-github-actions-and-iac-with-bicep.md)
- 一个 Azure 订阅，你对其拥有“所有者级访问权限”

## 练习 0：为实验室准备 Azure 订阅

> **注意：** 如果使用新的 Azure 订阅，可能无法注册一些 Azure 资源提供程序。 由于注册过程可能需要几分钟时间，因此为了尽量减少等待时间，你将在此实验室开始时注册它们。

> **注意：** 在此实验室中，你将使用 Azure Chaos Studio。 如果这是首次在订阅中使用 Azure Chaos Studio，则需要首先注册相应的资源提供程序。

1. 启动 Web 浏览器，并导航到位于 `https://portal.azure.com` 的 Azure 门户。
1. 如果系统提示，请使用对你在之前的实验室中使用的 Azure 订阅具有所有者访问权限的 Microsoft Entra ID 帐户登录。
1. 在显示 Azure 门户的 Web 浏览器选项卡中，在页面顶部的搜索文本框中输入“**订阅**”，然后在结果列表中选择“**订阅**”。
1. 在“订阅”页左侧的垂直菜单中，选择“**资源提供程序**”。
1. 在资源提供程序列表中，搜索并选择“**Microsoft.Chaos**”。
1. 选择“**Microsoft.Chaos**”资源提供程序后，在工具栏中选择“**注册**”。

   > **注意：** 不要等到注册完成，而是直接转到下一个练习。 注册可能需要几分钟时间。

## 练习 1：使用流量管理器增强工作负载复原能力

在本练习中，你将实现一个弹性配置，该配置使用 Azure 流量管理器在两个不同的 Azure 区域中的两个 .NET Web 应用实例之间分配请求。

> **注意：** 出于实验室的目的，我们将考虑在美国东部区域将基于 NET 的 Web 应用 eShopOnWeb 部署为主要实例。 虽然在这种情况下，此类考虑纯粹是任意的（仅用于演示目的），但在某些情况下，可能有利于确定其中一个终结点的优先级。

该练习由以下任务组成：

- 任务 1：实现流量管理器配置文件
- 任务 2：验证流量管理器功能

### 任务 1：实现流量管理器配置文件

1. 在显示 Azure 门户的 Web 浏览器选项卡中，在页面顶部的搜索文本框中输入“**流量管理器配置文件**”，然后在结果列表中选择“**流量管理器配置文件**”。
1. 在“**负载均衡 \| 流量管理器**”页上，选择“**+ 创建**”。
1. 在“**创建流量管理器配置文件**”页中，执行以下操作：

   - 在“**名称**”文本框中，输入 **devopsfoundationstmprofile**。

       > **注意：** 流量管理器配置文件的名称必须全局唯一。 如果收到一条错误消息，指出该名称已被使用，请尝试其他名称并务必记下该名称。 整个实验室都需要它。

   - 在“**路由方法**”下拉列表中，选择“**优先级**”。

   > **注意：** 我们选择优先级路由方法，以反映所有请求都应由美国东部的 Azure 应用服务 Web 应用处理的任意假设。

   - 验证 Azure 订阅是否显示在“**订阅**”下拉列表中
   - 在“**资源组**”下拉列表下方选择“**新建**”链接，在“**名称**”文本框中，输入 **devops-foundations-rg**，然后选择“**确定**”。
   - 在“**资源组位置**”下拉列表中，选择你在课程的上一个实验室中选择的同一 Azure 区域。

1. 选择“**创建**”以开始预配过程。

   > 备注：请等待部署完成。 此操作应在 1 分钟内完成。

1. 在“**负载均衡 \| 流量管理器**”页上，根据需要选择“**刷新**”，然后选择“**devopsfoundationstmprofile**”。
1. 在 **devopsfoundationstmprofile** 页上的“**Essentials**”部分中，复制“**DNS 名称**”设置的值并记录它。 整个实验室都需要它。
1. 在 **devopsfoundationstmprofile** 页上的左侧导航菜单中的“**设置**”部分中，选择“**配置**”。
1. 查看“**devopsfoundationstmprofile \| 配置**”页的内容。 请注意，默认情况下，**DNS 生存时间 (TTL)** 设置为 **60** 秒。 将该值更改为 **5** 秒。

   > **注意：** 降低 TTL 的值将加速故障转移。 

   > **注意：** 除了 TTL 值，探测间隔、探测超时和容忍的故障数都会影响检测到终结点故障的时间长短。

1. 在“**devopsfoundationstmprofile \| 配置**”页上的“**协议**”下拉列表中，选择 **HTTPS**，然后在“**端口**”文本框中输入 **443**。

   > **注意：** 可以通过默认 TCP 端口 443 上的 HTTPS 访问两个将配置为终结点的 Azure 应用服务 Web 应用。

1. 在“**devopsfoundationstmprofile \| 配置**”页上，选择“**保存**”。
1. 在“**devopsfoundationstmprofile**”页上的左侧导航菜单中的“**设置**”部分中，选择“**终结点**”。
1. 在“**devopsfoundationstmprofile \| 配置****”页上，选择“**+ 添加**”。

   > **注意：** 首先添加表示 Azure 应用服务 Web 应用的终结点。

1. 在“**添加终结点**”窗格中，执行以下操作：

   - 确保“**Azure 终结点**”显示在“**类型**”下拉列表中。
   - 在“**名称**”文本框中，输入“**DevOps Foundations Web 应用 - 美国东部**”。
   - 确保选中“**启用终结点**”复选框。
   - 在“**目标资源类型**”下拉列表中，选择“应用服务”。
   - 在“**目标资源**”下拉列表中，在“**rg-eshoponweb-eastus**”部分中，选择美国东部 Azure 区域中的应用服务 Web 应用的名称。
   - 在“**优先级**”文本框中，输入 **1**。

   > **注意：** 优先级数值越小，优先级越高。 在这种情况下，只要该实例保持可用，所有请求都将发送到美国东部区域的 Web 应用实例。

   - 确保“**运行状况检查**”已启用。

1. 选择 **添加** 。

1. 在“**devopsfoundationstmprofile \| 终结点****”页上，选择“**+ 添加**”。

   > **注意：** 接下来，添加一个终结点，该终结点表示部署到欧洲西部 Azure 区域的其他 Azure 应用服务 Web 应用。

1. 在“**添加终结点**”窗格中，执行以下操作：

   - 确保“**Azure 终结点**”显示在“**类型**”下拉列表中。
   - 在“**名称**”文本框中，输入“**DevOps Foundations Web 应用 - 欧洲西部**”。
   - 确保选中“**启用终结点**”复选框。
   - 在“**目标资源类型**”下拉列表中，选择“应用服务”。
   - 在“**目标资源**”下拉列表中，在“**rg-eshoponweb-eastus**”部分中，选择欧洲西部 Azure 区域中的应用服务 Web 应用的名称。
   - 在“**优先级**”文本框中，输入 **2**。
   - 确保“**运行状况检查**”已启用。

1. 选择 **添加** 。
1. 返回“**devopsfoundationstmprofile \| 终结点****”页，验证这两个终结点是否都列在“**监视器状态**”列中的“**联机**”条目中。

   > **注意：** 你可能需要等待几分钟，然后选择“**刷新**”，随后状态条目才为最新状态。

### 任务 2：验证流量管理器功能

1. 启动 Web 浏览器窗口并导航到与流量管理器配置文件关联的 DNS 名称。
1. 验证 Web 浏览器是否显示上一实验室中部署的 Azure 应用服务 Web 应用托管的网站的熟悉页面。
1. 关闭新打开的 Web 浏览器窗口。
1. 切换回显示 Azure 门户的 Web 浏览器窗口。
1. 在 Azure 门户中，选择搜索文本框右侧的“**Azure Cloud Shell**”图标。
1. 如有必要，请在 Cloud Shell 窗格左上角的下拉菜单中选中“**Bash**”。
1. 在 Cloud Shell 窗格中的 Bash 会话中，运行以下命令，将你在上一任务中创建的流量管理器配置文件的 DNS 名称解析为两个相应终结点之一（将占位符 `<tm_profile>` 替换为流量管理器配置文件的 DNS 名称，例如 `devopsfoundationstmprofile.trafficmanager.net`），但请务必删除前导 `https:\\`：

   ```cli
   nslookup <tm_profile>
   ```

1. 多次重新运行同一命令，每次调用之间等待的时间超过 5 秒（以消除 DNS 缓存的可能性），并请注意，每个情况下的输出都引用了美国东部 Azure 区域中 Web 应用的 DNS 名称。

## 练习 2：使用 Azure Chaos Studio 测试工作负载复原能力

在本练习中，你将使用 Azure Chaos Studio 测试工作负载的复原能力

> **注意：** 本练习说明了如何使用 Azure Chaos Studio。 Azure Chaos Studio 的目的是帮助衡量、理解和构建应用程序和服务复原能力。 这是通过有意中断工作负荷来实现的，目的是识别复原差距并主动实施相应的缓解措施，而不是被动地实施。

该练习由以下任务组成：

- 任务 1：配置 Azure Chaos Studio 环境
- 任务 2：实现试验
- 任务 3：验证试验

### 任务 1：配置 Azure Chaos Studio 环境

1. 在显示 Azure 门户的 Web 浏览器选项卡中，在页面顶部的搜索文本框中输入“**Chaos Studio**”，然后在结果列表中选择“**Chaos Studio**”。
1. 在 **Chaos Studio** 页上，选择“**目标**”。
1. 在“**Chaos Studio \| 目标**”页上，选择在上一实验室中部署的美国东部区域中的 **rg-eshoponweb-eastus** 资源组中的 Azure 应用服务 Web 应用实例。
1. 在工具栏中，选择“**启用目标**”下拉列表标头，然后在下拉列表中选择“**启用服务直接目标（所有资源）**”。
1. 在“**启用服务直接目标**”页上，确保列出正确的应用服务 Web 应用实例，选择“**查看 + 启用**”，然后选择“**启用**”。

   > **注意：** 等待启用目标。 这应该可以在一分钟内完成。

### 任务 2：实现试验

1. 在 Azure 门户中，在页面顶部的搜索文本框中输入“**Chaos Studio**”，然后在结果列表中选择“**Chaos Studio**”。
1. 在“**Chaos Studio**”页上，选择“**试验**”。
1. 在“**试验**”页上，选择“**+ 创建**”，然后在下拉列表中选择“**新试验**”。
1. 在“**创建试验**”页面的“**基本信息**”选项卡上，执行以下操作：

   - 验证 Azure 订阅是否显示在“**订阅**”下拉列表中。
   - 在“**资源组**”下拉列表下方选择“**新建**”链接，在“**名称**”文本框中，输入 **devops-foundations-rg**，然后选择“**确定**”。
   - 在“**试验详细信息**”部分的“**名称**”文本框中，输入“**DevOps_Foundations_Labs_Experiment_01**”。
   - 在“**区域**”下拉列表中，选择“**欧洲西部**”Azure 区域。

   > **注意：** 你可以选择任何 Azure 区域，但考虑到要测试的是西欧区域中的资源故障，除美国东部以外的任何区域似乎更合适。

1. 在“**创建试验**”页的“**基本信息**”选项卡上，选择“**下一步：。权限 >”**。
1. 在“**权限**”选项卡上，接受“**系统分配标识**”这一默认选项，然后选择“**下一步：试验设计器 >**”。
1. 在“**试验设计器**”选项卡上，执行以下操作：

   - 在“**步骤**”文本框中，输入“**步骤 1：应用服务 Web 应用故障转移**”。
   - 在“**分支**”文本框中输入“**分支 1：模仿应用服务故障**”。
   - 选择“**+ 添加操作**”，然后在下拉列表中选择“**添加错误**”。

1. 在“**添加故障**”窗格的“**故障详细信息**”选项卡上的“**故障**”下拉列表中，选择“**停止应用服务**”，并将“**持续时间（分钟）**”的值设置为 10。
1. 在“**添加故障**”窗格的“**故障详细信息**”选项卡上，选择“**下一步：目标资源 >**”。
1. 在“**添加故障**”窗格的“**目标资源**”选项卡上，确保选中“**手动从列表中选择**”选项，选择添加为 Chaos Studio 环境目标的应用服务 Web 应用，然后选择“**添加**”。
1. 返回“**创建试验**”页的“**试验设计器**”选项卡，选择“**查看 + 创建**”。
1. 在“**创建试验**”页的“**查看 + 创建**”选项卡上，选择“**创建**”。

   > **注意：** 等待试验创建完成。 这应该可以在一分钟内完成。

   > **注意：** 若要使试验成功，你还需要向新创建的托管服务帐户授予足以停止 Azure 应用服务 Web 应用的权限。 出于此目的，我们将利用内置 Azure 参与者角色，但如果想要遵循最低特权原则，可以创建自定义角色。

1. 在 Azure 门户中，在页面顶部的搜索文本框中，输入“**应用服务**”，并在结果列表中选择“**应用服务**”。
1. 在“**应用服务**”页上，选择在上一实验室中部署的美国东部区域中的 Azure 应用服务 Web 应用。
1. 在 web 应用页面上，在左侧垂直菜单中，选择“**访问控制 (IAM)**”。
1. 在 web 应用的“**访问控制 (IAM)**”页上，选择“**+ 添加**”，然后从下拉菜单中选择“**添加角色分配**”。
1. 在“**添加角色分配**”页的“**角色**”选项卡上，选择“**特权管理员角色**”，在角色列表中选择“**参与者**”，然后选择“**下一步**”。
1. 在“**添加角色分配**”页的“**成员**”选项卡上，将“**分配访问权限对象**”选项设置为“**托管标识**”，然后选择“**+ 选择成员**”。
1. 在“**选择托管标识**”窗格中的“**托管标识**”下拉列表中，选择“**混沌试验**”，在托管标识列表中选择之前在此任务中创建的标识，然后选择“**选择**”。
1. 返回“**添加角色分配**”页的“**成员**”选项卡上，选择“**审阅 + 分配**”，然后再次选择“**审阅 + 分配**”。

### 任务 3：验证试验

1. 在 Azure 门户中，导航回到“**Chaos Studio**”页，然后在左侧的垂直菜单中，选择“**试验**”。
1. 在试验列表中，选择 **DevOps_Foundations_Labs_Experiment_01**。
1. 在 **DevOps_Foundations_Labs_Experiment_01** 页上，选择“**开始**”，当系统提示确认时，选择“**确定**”。
1. 等待状态更改为“**正在运行**”。
1. 在 **DevOps_Foundations_Labs_Experiment_01** 页上的“**历史记录**”部分中，选择表示当前试验执行的条目中的“**详细信息**”链接。
1. 在 **DevOps_Foundations_Labs_Experiment_01** 试验详细信息页上，查看包含与试验关联的步骤、分支和操作的列表。

   > **注意：** 你可能需要选择工具栏条目“**刷新**”来更新列表的状态。

1. 选择“**操作**”条目以显示“**故障详细信息**”窗格。
1. 在“**运行目标**”部分中，选择表示 Azure 应用服务 Web 应用的条目。
1. 在 Web 应用页上的“**Essential**”部分中，请注意，Web 应用的状态将列为“**已停止**”。

   > **注意：** 你可能需要选择工具栏条目“**刷新**”来更新 Web 应用的状态。

   > **注意：** 现在，让我们验证流量管理器是否成功将目标为配置文件的请求重定向到表示西欧区域中的应用服务 Web 应用的终结点。

1. 启动 Web 浏览器并导航到与流量管理器配置文件关联的 DNS 名称。
1. 验证 Web 浏览器是否显示上一实验室中部署的 Azure 应用服务 Web 应用托管的网站的熟悉页面。
1. 切换回显示 Azure 门户的 Web 浏览器窗口。
1. 在 Azure 门户中，选择搜索文本框右侧的“**Azure Cloud Shell**”图标。
1. 在 Cloud Shell 窗格中的 Bash 会话中，运行以下命令，将你在上一任务中创建的流量管理器配置文件的 DNS 名称解析为两个相应终结点之一（将占位符 `<tm_profile>` 替换为流量管理器配置文件的 DNS 名称，但请务必删除前导 `https:\\`）：

   ```cli
   nslookup <tm_profile>
   ```

1. 多次重新运行同一命令，每次调用之间等待的时间超过 5 秒（以消除 DNS 缓存的可能性），并验证每个情况下的输出都引用了欧洲西部 Azure 区域中 Web 应用的 DNS 名称。

> **注意：** 虽然此示例看起来有点简单，但练习的主要目标是说明实现基于 Azure Chaos Studio 的测试的过程及其主要组件。 如果 Azure 应用服务 Web 应用是更复杂的环境的一部分，则使用等效的方法，其中故障的影响可能更具挑战性。

### 练习 3：删除实验室中使用的资源

在本练习中，你将删除本实验室中使用的资源。

1. 在显示 Azure 门户的 Web 浏览器选项卡中，在页面顶部的搜索文本框中输入“**资源组**”，然后在结果列表中选择“**订阅群**”。
1. 在“**资源组**”页上的资源组列表中，选择在当前实验室中创建的资源组。
1. 在资源组页上，选择“删除资源组”****。
1. 在“**输入资源组名称以确认删除**”文本框中，输入要删除的资源组的名称，然后选择“**删除**”。

   > **注意：** 等待资源组被删除。 这应该可以在一分钟内完成。

1. 为在本课程的上一个实验室中创建的资源组重复上一步。

    > **注意：** 删除资源组将删除与其关联的所有资源，包括流量管理器配置文件和 Azure Chaos Studio 环境。

    > **注意：** 无需删除在本课程的上一个实验室中创建的 GitHub 帐户和存储库。 你可以继续将它们用作工作组合。
